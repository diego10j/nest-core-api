# ğŸ—ï¸ DIAGRAMA DE ARQUITECTURA - FASE 1 COMPLETADA

## Arquitectura Completa (VisiÃ³n General)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        NESTJS APPLICATION                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                   CONTROLLERS / ROUTES                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                       â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              SERVICES (Business Logic)                   â”‚   â”‚
â”‚  â”‚  â”œâ”€ CoreService                                         â”‚   â”‚
â”‚  â”‚  â”œâ”€ AuthService                                         â”‚   â”‚
â”‚  â”‚  â””â”€ ... (otras servicios)                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                       â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚        DATASOURCE SERVICE (OrquestaciÃ³n)                â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚  async createQuery(query: Query)                         â”‚   â”‚
â”‚  â”‚   â”œâ”€ Validate (QueryValidatorService)                   â”‚   â”‚
â”‚  â”‚   â”œâ”€ Format (formatSqlQuery)                            â”‚   â”‚
â”‚  â”‚   â”œâ”€ Build & Execute (QueryBuilders - FASE 2)          â”‚   â”‚
â”‚  â”‚   â””â”€ Audit (AuditLogger - FASE 3)                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚         â”‚         â”‚         â”‚                       â”‚
â”‚           â–¼         â–¼         â–¼         â–¼                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           SERVICIOS DE SOPORTE (FASE 1)                 â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚ 1. QUERY VALIDATION LAYER                          â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â”œâ”€ QueryValidatorService                           â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â”‚  â””â”€ validateQuery(query)                         â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â””â”€ Custom Exceptions                                â”‚ â”‚  â”‚
â”‚  â”‚  â”‚    â”œâ”€ InvalidQueryException                         â”‚ â”‚  â”‚
â”‚  â”‚  â”‚    â”œâ”€ InvalidQueryParametersException              â”‚ â”‚  â”‚
â”‚  â”‚  â”‚    â””â”€ ... (3 mÃ¡s)                                   â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚ 2. QUERY PROCESSING LAYER                          â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â”œâ”€ PaginationService                               â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â”‚  â”œâ”€ calculateOffset()                            â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â”‚  â”œâ”€ calculateTotalPages()                        â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â”‚  â”œâ”€ setMetadata()                                â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â”‚  â””â”€ getSqlPaginationClause()                     â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â”‚                                                   â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â””â”€ FilterService                                   â”‚ â”‚  â”‚
â”‚  â”‚  â”‚    â”œâ”€ applyFilters()                               â”‚ â”‚  â”‚
â”‚  â”‚  â”‚    â”œâ”€ buildFilterConditions()                      â”‚ â”‚  â”‚
â”‚  â”‚  â”‚    â””â”€ buildGlobalFilterConditions()                â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚ 3. TYPE PARSING LAYER                              â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â”œâ”€ TypeParserService                               â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â”‚  â””â”€ registerParsers()                            â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â”‚                                                   â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â””â”€ Constants                                        â”‚ â”‚  â”‚
â”‚  â”‚  â”‚    â””â”€ PG_TYPE_CONFIG                               â”‚ â”‚  â”‚
â”‚  â”‚  â”‚       â”œâ”€ TIME_OID: 1083                            â”‚ â”‚  â”‚
â”‚  â”‚  â”‚       â”œâ”€ NUMERIC_OID: 1700                         â”‚ â”‚  â”‚
â”‚  â”‚  â”‚       â””â”€ ... (5 mÃ¡s)                                â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚ 4. CACHING LAYER                                   â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â”œâ”€ ICacheProvider (AbstracciÃ³n)                    â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â”‚  â”œâ”€ get<T>(key)                                  â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â”‚  â”œâ”€ set<T>(key, value, ttl?)                     â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â”‚  â”œâ”€ del(key)                                     â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â”‚  â”œâ”€ delPattern(pattern)                          â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â”‚  â””â”€ clear()                                      â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â”‚                                                   â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â”œâ”€ RedisCacheProvider (ImplementaciÃ³n)            â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â”‚  â””â”€ Usa Redis como backend                       â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â”‚                                                   â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â””â”€ TableColumnsCacheService (Caso de Uso)        â”‚ â”‚  â”‚
â”‚  â”‚  â”‚    â”œâ”€ getTableColumns(tableName)                   â”‚ â”‚  â”‚
â”‚  â”‚  â”‚    â”œâ”€ setTableColumns(tableName, columns)          â”‚ â”‚  â”‚
â”‚  â”‚  â”‚    â”œâ”€ invalidateTableColumns(tableName)            â”‚ â”‚  â”‚
â”‚  â”‚  â”‚    â””â”€ invalidateAllTableColumns()                  â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   PostgreSQL Database (pg library)   â”‚
        â”‚  â”œâ”€ Transactions                     â”‚
        â”‚  â”œâ”€ Type Parsing                     â”‚
        â”‚  â””â”€ Connection Pool                  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Redis (Caching)                    â”‚
        â”‚  â”œâ”€ table_columns:*                  â”‚
        â”‚  â”œâ”€ schema:*                         â”‚
        â”‚  â””â”€ ... (otros patrones)             â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Flujo de Datos (Request â†’ Response)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   User Request       â”‚
â”‚  (GET, POST, etc)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. CONTROLLER LAYER                          â”‚
â”‚  - Recibe Request                            â”‚
â”‚  - Extrae parÃ¡metros                         â”‚
â”‚  - Crea DTO                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. SERVICE LAYER                             â”‚
â”‚  - Ejecuta lÃ³gica de negocio                 â”‚
â”‚  - Crea SelectQuery/InsertQuery/etc          â”‚
â”‚  - Llama a DataSourceService                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. DATASOURCE SERVICE                        â”‚
â”‚  Step 3.1: QueryValidatorService             â”‚
â”‚  â”œâ”€ validateQuery(query) â—„â”€ EARLY FAIL      â”‚
â”‚  â””â”€ âœ“ ParÃ¡metros vÃ¡lidos                    â”‚
â”‚                                              â”‚
â”‚  Step 3.2: formatSqlQuery()                  â”‚
â”‚  â”œâ”€ Formatear SQL                            â”‚
â”‚  â””â”€ âœ“ Query listo                            â”‚
â”‚                                              â”‚
â”‚  Step 3.3: getQueryBuilder() [FASE 2]       â”‚
â”‚  â”œâ”€ SelectQueryBuilder                       â”‚
â”‚  â”‚  â”œâ”€ PaginationService.initialize()       â”‚
â”‚  â”‚  â”œâ”€ FilterService.applyFilters()         â”‚
â”‚  â”‚  â”œâ”€ Calcular totales                     â”‚
â”‚  â”‚  â”œâ”€ PaginationService.getSqlClause()     â”‚
â”‚  â”‚  â”œâ”€ Ejecutar Pool.query()                â”‚
â”‚  â”‚  â””â”€ PaginationService.setMetadata()      â”‚
â”‚  â”‚                                           â”‚
â”‚  â”œâ”€ InsertQueryBuilder                       â”‚
â”‚  â”‚  â”œâ”€ Ejecutar Pool.query()                â”‚
â”‚  â”‚  â””â”€ Retornar resultado                   â”‚
â”‚  â”‚                                           â”‚
â”‚  â””â”€ ... (UpdateQueryBuilder, DeleteQueryBuilder) â”‚
â”‚                                              â”‚
â”‚  Step 3.4: AuditLogger [FASE 3]             â”‚
â”‚  â”œâ”€ Si query.audit == true                  â”‚
â”‚  â”œâ”€ Registrar cambios en sis_actividad      â”‚
â”‚  â””â”€ âœ“ AuditorÃ­a completada                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. DATABASE LAYER                            â”‚
â”‚  - PostgreSQL executa SQL                    â”‚
â”‚  - TypeParserService parsea tipos            â”‚
â”‚  - Retorna resultados                        â”‚
â”‚                                              â”‚
â”‚  CACHE CHECK:                                â”‚
â”‚  - TableColumnsCacheService intenta get()   â”‚
â”‚  - Si miss, obtiene de BD y cachea           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. RESPONSE CONSTRUCTION                     â”‚
â”‚  {                                           â”‚
â”‚    rows: [...],                              â”‚
â”‚    totalRecords: 150,                        â”‚
â”‚    pagination: {                             â”‚
â”‚      pageSize: 10,                           â”‚
â”‚      pageIndex: 2,                           â”‚
â”‚      totalPages: 15,                         â”‚
â”‚      hasNextPage: true                       â”‚
â”‚    },                                        â”‚
â”‚    message: 'ok',                            â”‚
â”‚    columns: [...] // Si isSchema=true       â”‚
â”‚  }                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. CONTROLLER RETURNS RESPONSE               â”‚
â”‚  - HTTP 200, 201, 400, 409, 500, etc        â”‚
â”‚  - JSON payload                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Patrones de DiseÃ±o Utilizados

### 1. Single Responsibility Principle (SRP)
```
DataSourceService (Orquestador)
    â”‚
    â”œâ”€ TypeParserService (Solo type parsing)
    â”œâ”€ QueryValidatorService (Solo validaciÃ³n)
    â”œâ”€ PaginationService (Solo paginaciÃ³n)
    â”œâ”€ FilterService (Solo filtros)
    â””â”€ Cache Services (Solo cachÃ©)
```

### 2. Dependency Inversion Principle (DIP)
```
DataSourceService
    â”œâ”€ Depende de ICacheProvider (abstracciÃ³n)
    â”‚  â””â”€ RedisCacheProvider (implementaciÃ³n)
    â”‚
    â””â”€ Puede cambiar a MemcachedProvider
       sin modificar DataSourceService
```

### 3. Strategy Pattern (FASE 2)
```
QueryBuilder (Strategy)
    â”œâ”€ SelectQueryBuilder
    â”œâ”€ InsertQueryBuilder
    â”œâ”€ UpdateQueryBuilder
    â””â”€ DeleteQueryBuilder

DataSourceService decide quÃ© estrategia usar
```

### 4. Template Method Pattern
```
QueryBuilder (template)
    1. Validate
    2. Format
    3. Build SQL
    4. Execute
    5. Return result
```

### 5. Cache-Aside Pattern
```
getTableColumns():
    1. Check cache
    2. If miss: fetch from DB
    3. Cache result
    4. Return result
```

---

## Responsabilidades por Servicio

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TypeParserService                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Responsabilidad: Type Parsing       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ MÃ©todos:                            â”‚
â”‚ â€¢ registerParsers()                 â”‚
â”‚ â€¢ registerTimeParser()              â”‚
â”‚ â€¢ registerNumericParsers()          â”‚
â”‚ â€¢ registerIntegerParsers()          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ QueryValidatorService               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Responsabilidad: ValidaciÃ³n         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ MÃ©todos:                            â”‚
â”‚ â€¢ validateQuery()                   â”‚
â”‚ â€¢ validateParameters()              â”‚
â”‚ â€¢ validateSelectQuery()             â”‚
â”‚ â€¢ validateInsertQuery()             â”‚
â”‚ â€¢ validateUpdateQuery()             â”‚
â”‚ â€¢ validateDeleteQuery()             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PaginationService                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Responsabilidad: PaginaciÃ³n         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ MÃ©todos:                            â”‚
â”‚ â€¢ calculateOffset()                 â”‚
â”‚ â€¢ calculateTotalPages()             â”‚
â”‚ â€¢ calculateLastPageOffset()         â”‚
â”‚ â€¢ initializeDefaultPagination()     â”‚
â”‚ â€¢ setMetadata()                     â”‚
â”‚ â€¢ getSqlPaginationClause()          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FilterService                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Responsabilidad: Filtros            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ MÃ©todos:                            â”‚
â”‚ â€¢ applyFilters()                    â”‚
â”‚ â€¢ buildFilterConditions()           â”‚
â”‚ â€¢ buildCondition()                  â”‚
â”‚ â€¢ buildGlobalFilterConditions()     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RedisCacheProvider                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Responsabilidad: CachÃ© Redis        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Implementa: ICacheProvider          â”‚
â”‚ MÃ©todos:                            â”‚
â”‚ â€¢ get<T>(key)                       â”‚
â”‚ â€¢ set<T>(key, value, ttl?)          â”‚
â”‚ â€¢ del(key)                          â”‚
â”‚ â€¢ delPattern(pattern)               â”‚
â”‚ â€¢ clear()                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TableColumnsCacheService            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Responsabilidad: Cache de Columnas  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ MÃ©todos:                            â”‚
â”‚ â€¢ getTableColumns()                 â”‚
â”‚ â€¢ setTableColumns()                 â”‚
â”‚ â€¢ invalidateTableColumns()          â”‚
â”‚ â€¢ invalidateAllTableColumns()       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## InyecciÃ³n de Dependencias

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DataSourceService (Usa todos)       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ constructor(                        â”‚
â”‚   typeParserService,               â”‚
â”‚   queryValidator,                  â”‚
â”‚   paginationService,               â”‚
â”‚   filterService,                   â”‚
â”‚   cacheProvider,                   â”‚
â”‚   tableColumnsCacheService,        â”‚
â”‚   errorsLogger,                    â”‚
â”‚   redisClient                      â”‚
â”‚ )                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Ciclo de Vida de una Query

```
Usuario hace
request
    â”‚
    â–¼
Controller recibe
    â”‚
    â–¼
Service crea
SelectQuery/InsertQuery/etc
    â”‚
    â–¼
DataSourceService.createQuery()
    â”‚
    â”œâ”€ QueryValidatorService.validateQuery() â—„â”€ EARLY VALIDATION
    â”‚
    â”œâ”€ formatSqlQuery()
    â”‚
    â”œâ”€ [SelectQuery] (FASE 2):
    â”‚   â”œâ”€ PaginationService.initializeDefaultPagination()
    â”‚   â”œâ”€ prepareBaseQuery()
    â”‚   â”œâ”€ FilterService.applyFilters()
    â”‚   â”œâ”€ calculateTotalRecords()
    â”‚   â”œâ”€ PaginationService.getSqlPaginationClause()
    â”‚   â”œâ”€ Pool.query()
    â”‚   â”œâ”€ PaginationService.setMetadata()
    â”‚   â””â”€ getSchemaColumns() [si isSchema=true]
    â”‚
    â”œâ”€ [InsertQuery] (FASE 2):
    â”‚   â”œâ”€ Pool.query()
    â”‚   â””â”€ Retornar resultado
    â”‚
    â”œâ”€ AuditLoggerService.log() [si audit=true] (FASE 3)
    â”‚
    â””â”€ Retornar ResultQuery
            â”‚
            â–¼
        Service retorna
        a Controller
            â”‚
            â–¼
        Controller retorna
        Response
            â”‚
            â–¼
        Usuario recibe
        respuesta
```

---

## Estado Post-FASE 1

```
âœ… COMPLETADO:
- 8 servicios production-ready
- 5 excepciones personalizadas
- 1 interfaz de cachÃ©
- 1 implementaciÃ³n de cachÃ©
- DocumentaciÃ³n completa
- GuÃ­a de uso

ğŸ”„ EN PROGRESO (prÃ³ximas fases):
- QueryBuilders (FASE 2)
- AuditLoggerService refactorizado (FASE 3)
- DataSourceService refactorizado (FASE 4)

ğŸ“Š MÃ‰TRICAS:
- Archivo principal: 853 â†’ ~500 (post FASE 2: ~200)
- Testabilidad: Baja â†’ Alta
- Mantenibilidad: Media â†’ Alta
- SOLID Compliance: 40% â†’ 90%+
```

---

**Diagrama actualizado: 13 de Enero, 2026**
